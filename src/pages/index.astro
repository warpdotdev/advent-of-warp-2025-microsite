---
import "../styles/global.css";
import "@fontsource/gelasio";
import "@fontsource/instrument-serif";
import { getCollection, render } from "astro:content";

const BASE_W = 1042;
const BASE_H = 632;
const toPct = (value: number, base: number) => ((value / base) * 100).toFixed(4);

// Drawer positions from Figma (relative to calendar container with 6px padding)
// Format: [day, left, top, width, height]
const drawers = [
  [1, 6, 6, 256, 231],
  [2, 264, 6, 170, 154],
  [3, 436, 6, 170, 231],
  [4, 608, 6, 256, 154],
  [5, 866, 6, 170, 154],
  [6, 6, 239, 85, 154],
  [7, 92, 239, 170, 154],
  [8, 264, 162, 170, 153],
  [9, 436, 239, 170, 76],
  [10, 608, 162, 84, 153],
  [11, 694, 162, 170, 66],
  [12, 866, 162, 170, 162],
  [13, 6, 397, 256, 71],
  [14, 264, 317, 84, 153],
  [15, 350, 319, 170, 149],
  [16, 522, 317, 170, 231],
  [17, 694, 230, 170, 163],
  [18, 866, 326, 170, 66],
  [19, 6, 473, 170, 153],
  [20, 178, 473, 256, 153],
  [21, 436, 473, 84, 154],
  [22, 522, 550, 256, 76],
  [23, 694, 395, 84, 153],
  [24, 780, 395, 84, 231],
  [25, 866, 395, 170, 231],
] as const;

const days = await getCollection("days");
const daysWithContent = await Promise.all(
  days.map(async (day) => {
    const { Content } = await render(day);
    return { ...day, Content };
  })
);
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>Advent of Warp</title>
	</head>
<body class="winter-bg">
		<header class="site-header">
			<h1>Advent of Warp 2025</h1>
		</header>
		<main class="page">
			<div class="calendar-frame">
				<div class="calendar">
				{drawers.map(([day, left, top, width, height]) => {
					const leftPct = toPct(left, BASE_W);
					const topPct = toPct(top, BASE_H);
					const widthPct = toPct(width, BASE_W);
					const heightPct = toPct(height, BASE_H);

					return (
						<button
							class="drawer"
							data-day={day}
							style={`left: ${leftPct}%; top: ${topPct}%; width: ${widthPct}%; height: ${heightPct}%`}
						>
							<img
								src={`/assets/drawers/day-${day}.png`}
								alt={`Day ${day}`}
							/>
							<img
								class="letter"
								src="/assets/drawers/letter.png"
								alt=""
							/>
						</button>
					);
				})}
				</div>
			</div>
		</main>
		<footer class="site-footer">
			<a href="https://github.com/warpdotdev/advent-of-warp-2025-microsite" target="_blank" rel="noopener">Built with agent mode</a>
		</footer>

		<dialog id="modal">
			<button class="close-btn" aria-label="Close">&times;</button>
			<div class="modal-content">
				<h2 id="modal-title"></h2>
				<div id="modal-body"></div>
				<a id="modal-link" href="#" target="_blank" rel="noopener" class="cta-button">See how it works</a>
			</div>
		</dialog>

		<!-- Pre-rendered content for each day -->
		<div id="day-content" style="display: none;">
			{daysWithContent.map((day) => (
				<div data-content={day.id} data-url={day.data.url}>
					<day.Content />
				</div>
			))}
		</div>

		<script>
			const modal = document.getElementById('modal') as HTMLDialogElement;
			const modalTitle = document.getElementById('modal-title')!;
			const modalBody = document.getElementById('modal-body')!;
			const modalLink = document.getElementById('modal-link') as HTMLAnchorElement;
			const closeBtn = modal.querySelector('.close-btn')!;

			const SLIDE_ROTATE_DURATION = 200; // ms for slide out + rotate animation

			let activeLetter: HTMLElement | null = null;

			document.querySelectorAll('.drawer[data-day]').forEach((btn) => {
				btn.addEventListener('click', () => {
					const day = btn.getAttribute('data-day');
					const paddedDay = day!.padStart(2, '0');
					const content = document.querySelector(`[data-content="${paddedDay}"]`);
					const letter = btn.querySelector('.letter') as HTMLElement;
					
					if (!content) return;

					// Store content for later
					modalTitle.textContent = `Day ${day}`;
					modalBody.innerHTML = content.innerHTML;
					modalLink.href = content.getAttribute('data-url') || '#';

					// Step 1 & 2: Slide out and rotate via keyframe animation
					letter.classList.add('animating');
					activeLetter = letter;

					// Step 3: After animation completes, do view transition to modal
					setTimeout(() => {
						if (!document.startViewTransition) {
							modal.showModal();
							letter.classList.remove('animating');
							return;
						}

						// Give the letter a view-transition-name for the morph
						letter.style.viewTransitionName = 'active-letter';
						modal.style.viewTransitionName = 'active-letter';

						const transition = document.startViewTransition(() => {
							letter.classList.remove('animating');
							letter.style.viewTransitionName = '';
							modal.showModal();
						});

						transition.finished.then(() => {
							modal.style.viewTransitionName = '';
							activeLetter = null;
						});
					}, SLIDE_ROTATE_DURATION);
				});
			});

			closeBtn.addEventListener('click', () => modal.close());
			modal.addEventListener('click', (e) => {
				if (e.target === modal) modal.close();
			});
		</script>
	</body>
</html>

<style is:global>
	#modal-body code {
		background: rgba(76, 19, 25, 0.08);
		border: 1px solid #4C1319;
		border-radius: 4px;
		padding: 0.1rem 0.35rem;
		font-size: 0.95em;
		display: inline-block;
	}
</style>

<style>
	.winter-bg {
		min-height: 100vh;
		overflow: hidden;
		background: url('/assets/winter-bg.png') no-repeat center center fixed;
		background-size: cover;
		display: flex;
		flex-direction: column;
	}

	.site-header {
		text-align: center;
		padding: 1.5rem 1rem 0.5rem;
	}

	.site-header h1 {
		font-family: 'Instrument Serif', serif;
		font-style: italic;
		font-size: 2.5rem;
		color: white;
		text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
		margin: 0;
	}

	.site-footer {
		text-align: center;
		padding: 0.75rem 1rem 3rem;
		margin-top: auto;
	}

	.site-footer a {
		font-family: 'Gelasio', serif;
		color: white;
		text-shadow: 0 1px 4px rgba(0, 0, 0, 0.5);
		transition: opacity 0.15s ease;
	}

	.site-footer a:hover {
		opacity: 0.8;
		text-decoration: underline;
	}

	.page {
		width: 100%;
		padding: 1rem;
		display: flex;
		justify-content: center;
	}

	.calendar-frame {
		position: relative;
		width: 100%;
		max-width: 1048px;
		aspect-ratio: 1048 / 638;
		padding: 6px;
		box-sizing: border-box;
		border-radius: 14px;
		box-shadow: 0 0 0 6px rgba(0, 0, 0, 0.3);
	}

	.calendar-frame::before {
		content: '';
		position: absolute;
		inset: 0;
		background: url('/assets/wood-texture.png') repeat;
		border-radius: 14px;
		z-index: -1;
	}

	.calendar {
		position: relative;
		width: 100%;
		height: 100%;
		background-color: #3d2a1a;
		border-radius: 8px;
	}

	.drawer {
		position: absolute;
		border-radius: 4px;
		padding: 0;
		border: none;
		background: none;
		cursor: pointer;
		transition: transform 0.15s ease, box-shadow 0.15s ease;
		clip-path: inset(-400% -10% 2px -10%);
	}

	.drawer:hover {
		transform: scale(1.02);
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
	}

	/* One off. 22 is positioned below day 23 visually, so increase z-index */
	.drawer[data-day="22"] {
		z-index: 1;
	}

	.drawer > img:first-child {
		width: 100%;
		height: 100%;
		object-fit: cover;
		border-radius: 4px;
		display: block;
	}

	.letter {
		position: absolute;
		left: 50%;
		top: 0;
		width: 100%;
		max-width: 200px;
		aspect-ratio: 4/3;
		transform: translateX(-50%) translateY(20%) rotate(90deg);

		transition: transform 0.25s ease-out;
		pointer-events: none;
		z-index: -1;
	}

	.drawer:hover .letter {
		transform: translateX(-50%) translateY(-40%) rotate(90deg);
	}

	/* Letter slide-out and rotate animation */
	@keyframes letter-slide-rotate {
		0% {
			transform: translateX(-50%) translateY(-40%) rotate(90deg);
		}
		100% {
			transform: translateX(-50%) translateY(-110%);
		}
	}

	.letter.animating {
		animation: letter-slide-rotate 200ms ease forwards;
	}

	/* Modal styles */
	dialog {
		padding: 0;
		border: none;
		border-radius: 12px;
		min-width: 400px;
		max-width: 500px;
		width: 90%;
		min-height: 300px;
		background-image: url('/assets/letter-texture.png');
		background-size: cover;
		box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
		border: 4px solid #4C1319;
		position: fixed;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
		margin: 0;
		aspect-ratio: 4 / 3;
	}

	dialog::backdrop {
		background: rgba(0, 0, 0, 0.7);
	}

	.modal-content {
		padding: 1.2rem;
		font-family: 'Gelasio', serif;
		text-align: center;
	}

	.close-btn {
		position: absolute;
		top: 0.5rem;
		right: 0.5rem;
		background: rgba(0, 0, 0, 0.3);
		border: none;
		font-size: 1.5rem;
		width: 2rem;
		height: 2rem;
		border-radius: 50%;
		cursor: pointer;
		color: white;
		line-height: 1;
		transition: background 0.15s ease;
	}

	.close-btn:hover {
		background: rgba(0, 0, 0, 0.5);
	}

	#modal-title {
		margin: 0 0 1rem;
		font-family: 'Instrument Serif', serif;
		font-style: italic;
		font-size: 1.8rem;
		color: #1d3d11;
	}

	#modal-body {
		color: #333;
		line-height: 1.6;
		margin-bottom: 1.5rem;
		text-align: left;
	}

	#modal-body p {
		margin: 0 0 0.75rem;
	}

	#modal-body ul {
		margin: 0 0 0.75rem;
		padding-left: 1.5rem;
	}

	.cta-button {
		display: inline-block;
		background: #1d3d11;
		color: white;
		padding: 0.75rem 1.5rem;
		border-radius: 8px;
		text-decoration: none;
		font-weight: 500;
		transition: background-color 0.15s ease;
	}

	.cta-button:hover {
		background: #2a5a1a;
	}
</style>
