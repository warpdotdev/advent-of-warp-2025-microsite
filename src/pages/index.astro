---
import "../styles/global.css";
import "@fontsource/gelasio";
import { getCollection, render } from "astro:content";

const BASE_W = 1042;
const BASE_H = 632;
const toPct = (value: number, base: number) => ((value / base) * 100).toFixed(4);

// Drawer positions from Figma (relative to calendar container with 6px padding)
// Format: [day, left, top, width, height]
const drawers = [
  [1, 6, 6, 256, 231],
  [2, 264, 6, 170, 154],
  [3, 436, 6, 170, 231],
  [4, 608, 6, 256, 154],
  [5, 866, 6, 170, 154],
  [6, 6, 239, 85, 154],
  [7, 92, 239, 170, 154],
  [8, 264, 162, 170, 153],
  [9, 436, 239, 170, 76],
  [10, 608, 162, 84, 153],
  [11, 694, 162, 170, 66],
  [12, 866, 162, 170, 162],
  [13, 6, 397, 256, 71],
  [14, 264, 317, 84, 153],
  [15, 350, 319, 170, 149],
  [16, 522, 317, 170, 231],
  [17, 694, 230, 170, 163],
  [18, 866, 326, 170, 66],
  [19, 6, 473, 170, 153],
  [20, 178, 473, 256, 153],
  [21, 436, 473, 84, 154],
  [22, 522, 550, 256, 76],
  [23, 694, 395, 84, 153],
  [24, 780, 395, 84, 231],
  [25, 866, 395, 170, 231],
] as const;

const days = await getCollection("days");
const daysWithContent = await Promise.all(
  days.map(async (day) => {
    const { Content } = await render(day);
    return { ...day, Content };
  })
);
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>Advent Calendar</title>
	</head>
<body>
		<main class="page">
			<div class="calendar">
				{drawers.map(([day, left, top, width, height]) => {
					const leftPct = toPct(left, BASE_W);
					const topPct = toPct(top, BASE_H);
					const widthPct = toPct(width, BASE_W);
					const heightPct = toPct(height, BASE_H);

					return (
						<button
							class="drawer"
							data-day={day}
							style={`left: ${leftPct}%; top: ${topPct}%; width: ${widthPct}%; height: ${heightPct}%;`}
						>
							<img
								src={`/assets/drawers/day-${day}.png`}
								alt={`Day ${day}`}
							/>
						</button>
					);
				})}
			</div>
		</main>

		<dialog id="modal">
			<button class="close-btn" aria-label="Close">&times;</button>
			<div class="modal-content">
				<h2 id="modal-title"></h2>
				<div id="modal-body"></div>
				<a id="modal-link" href="#" target="_blank" rel="noopener" class="tweet-btn">View Tweet</a>
			</div>
		</dialog>

		<!-- Pre-rendered content for each day -->
		<div id="day-content" style="display: none;">
			{daysWithContent.map((day) => (
				<div data-content={day.id} data-url={day.data.url}>
					<day.Content />
				</div>
			))}
		</div>

		<script>
			const modal = document.getElementById('modal') as HTMLDialogElement;
			const modalTitle = document.getElementById('modal-title')!;
			const modalBody = document.getElementById('modal-body')!;
			const modalLink = document.getElementById('modal-link') as HTMLAnchorElement;
			const closeBtn = modal.querySelector('.close-btn')!;

			document.querySelectorAll('.drawer[data-day]').forEach((btn) => {
				btn.addEventListener('click', () => {
					const day = btn.getAttribute('data-day');
					const paddedDay = day!.padStart(2, '0');
					const content = document.querySelector(`[data-content="${paddedDay}"]`);
					
					console.log(content, paddedDay)
					if (content) {
						modalTitle.textContent = `Day ${day}`;
						modalBody.innerHTML = content.innerHTML;
						modalLink.href = content.getAttribute('data-url') || '#';
						modal.showModal();
					}
				});
			});

			closeBtn.addEventListener('click', () => modal.close());
			modal.addEventListener('click', (e) => {
				if (e.target === modal) modal.close();
			});
		</script>
	</body>
</html>

<style>
	.page {
		width: 100%;
		padding: 1rem;
		display: flex;
		justify-content: center;
	}

	.calendar {
		position: relative;
		width: 100%;
		max-width: 1048px;
		aspect-ratio: 1048 / 638;
		box-sizing: border-box;
		background-color: #3d2a1a;
		border-radius: 14px;
		padding: 6px;
		border: 6px solid transparent;
		border-image: url('/assets/wood-texture.png') 30 round;
		box-shadow: 0 0 0 6px rgba(0, 0, 0, 0.3);
	}

	.drawer {
		position: absolute;
		border-radius: 4px;
		padding: 0;
		border: none;
		background: none;
		cursor: pointer;
		transition: transform 0.15s ease, box-shadow 0.15s ease;
	}

	.drawer:hover {
		transform: scale(1.02);
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
	}

	.drawer img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		border-radius: 4px;
		display: block;
	}

	/* Modal styles */
	dialog {
		padding: 0;
		border: none;
		border-radius: 12px;
		min-width: 400px;
		max-width: 500px;
		width: 90%;
		min-height: 300px;
		background-image: url('/assets/letter-texture.png');
		background-size: cover;
		box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
		border: 4px solid #4C1319;
		position: fixed;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
		margin: 0;
	}

	dialog::backdrop {
		background: rgba(0, 0, 0, 0.7);
	}

	.modal-content {
		padding: 2rem;
		font-family: 'Gelasio', serif;
		text-align: center;
	}

	.close-btn {
		position: absolute;
		top: 0.5rem;
		right: 0.5rem;
		background: rgba(0, 0, 0, 0.3);
		border: none;
		font-size: 1.5rem;
		width: 2rem;
		height: 2rem;
		border-radius: 50%;
		cursor: pointer;
		color: white;
		line-height: 1;
		transition: background 0.15s ease;
	}

	.close-btn:hover {
		background: rgba(0, 0, 0, 0.5);
	}

	#modal-title {
		margin: 0 0 1rem;
		font-size: 1.5rem;
		color: #1d3d11;
	}

	#modal-body {
		color: #333;
		line-height: 1.6;
		margin-bottom: 1.5rem;
		text-align: left;
	}

	#modal-body p {
		margin: 0 0 0.75rem;
	}

	#modal-body ul {
		margin: 0 0 0.75rem;
		padding-left: 1.5rem;
	}

	.tweet-btn {
		display: inline-block;
		background: #1d3d11;
		color: white;
		padding: 0.75rem 1.5rem;
		border-radius: 8px;
		text-decoration: none;
		font-weight: 500;
		transition: background 0.15s ease;
	}

	.tweet-btn:hover {
		background: #2a5a1a;
	}
</style>
